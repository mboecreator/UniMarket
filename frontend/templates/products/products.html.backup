{% extends 'base.html' %}
{% load static %}

{% block title %}Products - University Local Market{% endblock %}

{% block content %}
<!-- Horizontal Categories Navigation -->
<div class="horizontal-categories">
    <div class="horizontal-categories-container">
        <a href="?category=" class="category-link {% if not selected_category %}active{% endif %}" data-category="all">All</a>
        {% for category in categories %}
            <a href="?category={{ category.id }}" class="category-link {% if selected_category == category.id|stringformat:'s' %}active{% endif %}" data-category="{{ category.name|lower }}">{{ category.name }}</a>
        {% endfor %}
    </div>
    <button class="scroll-arrow right" id="scrollRight"><i class="fas fa-chevron-right"></i></button>
</div>

<!-- Main Content -->
<div class="main-content">
    <!-- Categories Sidebar -->
    <div class="categories-sidebar">
        <h3>All Categories</h3>
        <ul id="categoriesList">
            <li data-category="all" class="{% if not selected_category %}active{% endif %}">
                <i class="fas fa-th-large"></i> All Products
            </li>
            {% for category in categories %}
            <li data-category="{{ category.name|lower }}" class="{% if selected_category == category.id|stringformat:'s' %}active{% endif %}">
                <i class="fas fa-tag"></i> {{ category.name }}
                <span class="badge">{{ category.products.count }}</span>
            </li>
            {% endfor %}
        </ul>
    </div>

    <!-- Products Feed -->
    <div class="posts-feed">
        <h2 id="feedTitle">
            {% if selected_category %}
                {% for category in categories %}
                    {% if category.id|stringformat:"s" == selected_category %}
                        {{ category.name }} Products
                    {% endif %}
                {% endfor %}
            {% else %}
                All Products
            {% endif %}
        </h2>

        <!-- Advanced Filters -->
        <div class="advanced-filters">
            <div class="filters-header">
                <h3><i class="fas fa-sliders-h"></i> Advanced Filters</h3>
                <div class="filters-toggle">
                    <span>Show Filters</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
            </div>
            <div class="filters-body">
                <div class="filter-section">
                    <h4>Price Range</h4>
                    <div class="price-range">
                        <div class="price-inputs">
                            <div class="field">
                                <span>$</span>
                                <input type="number" class="input-min" value="0" min="0">
                            </div>
                            <div class="separator">to</div>
                            <div class="field">
                                <span>$</span>
                                <input type="number" class="input-max" value="2000" min="0">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="filter-section">
                    <h4>Condition</h4>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="condition-new" checked>
                            <label for="condition-new">New</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="condition-like-new" checked>
                            <label for="condition-like-new">Like New</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="condition-good" checked>
                            <label for="condition-good">Good</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="condition-fair">
                            <label for="condition-fair">Fair</label>
                        </div>
                    </div>
                </div>

                <div class="filter-actions">
                    <button class="reset-btn">Reset All</button>
                    <button class="apply-btn">Apply Filters</button>
                </div>
            </div>
        </div>

        <!-- Filter and Sort Bar -->
        <div class="filter-sort-bar">
            <div class="filter-section">
                <div class="price-filter">
                    <span class="filter-label">Quick Filter:</span>
                    <form method="GET" style="display: inline-flex; align-items: center; gap: 10px;">
                        {% if selected_category %}
                            <input type="hidden" name="category" value="{{ selected_category }}">
                        {% endif %}
                        <div class="price-inputs">
                            <input type="number" name="min_price" placeholder="Min" min="0" value="{{ request.GET.min_price }}">
                            <span class="price-separator">-</span>
                            <input type="number" name="max_price" placeholder="Max" min="0" value="{{ request.GET.max_price }}">
                        </div>
                        <button type="submit" class="filter-btn">
                            <i class="fas fa-filter"></i>
                        </button>
                    </form>
                </div>
            </div>
            <div class="sort-section">
                <form method="GET" style="display: inline-flex; align-items: center; gap: 10px;">
                    {% if selected_category %}
                        <input type="hidden" name="category" value="{{ selected_category }}">
                    {% endif %}
                    {% if request.GET.min_price %}
                        <input type="hidden" name="min_price" value="{{ request.GET.min_price }}">
                    {% endif %}
                    {% if request.GET.max_price %}
                        <input type="hidden" name="max_price" value="{{ request.GET.max_price }}">
                    {% endif %}
                    <label for="sortOptions" class="filter-label">Sort by:</label>
                    <select name="sort" id="sortOptions" class="sort-select" onchange="this.form.submit()">
                        <option value="newest" {% if request.GET.sort == 'newest' %}selected{% endif %}>Newest</option>
                        <option value="price_low" {% if request.GET.sort == 'price_low' %}selected{% endif %}>Price: Low to High</option>
                        <option value="price_high" {% if request.GET.sort == 'price_high' %}selected{% endif %}>Price: High to Low</option>
                        <option value="popular" {% if request.GET.sort == 'popular' %}selected{% endif %}>Most Popular</option>
                    </select>
                </form>
            </div>
        </div>

        <div id="postsContainer" class="posts-container">
            {% if products %}
                {% for product in products %}
                <div class="product-card">
                    <div class="product-image">
                        {% if product.status == 'available' %}
                            <span class="product-badge badge-new">Available</span>
                        {% elif product.status == 'sold' %}
                            <span class="product-badge badge-sold">Sold</span>
                        {% else %}
                            <span class="product-badge badge-reserved">Reserved</span>
                        {% endif %}
                        
                        {% if product.image %}
                            <img src="{{ product.image.url }}" alt="{{ product.title }}">
                        {% else %}
                            <img src="https://via.placeholder.com/250x180/f0f0f0/999999?text=No+Image" alt="{{ product.title }}">
                        {% endif %}
                        
                        <div class="product-wishlist">
                            <i class="far fa-heart"></i>
                        </div>
                        <div class="product-actions">
                            <a href="{% url 'product_detail' product.id %}" class="action-button">
                                <i class="fas fa-eye"></i> View Details
                            </a>
                        </div>
                    </div>
                    <div class="product-info">
                        <div class="product-category">{{ product.category.name }}</div>
                        <h3 class="product-title">{{ product.title }}</h3>
                        <div class="product-price">
                            <span class="current-price">${{ product.price }}</span>
                        </div>
                        <div class="product-moq">
                            Posted {{ product.created_at|timesince }} ago
                            {% if product.location %}
                                â€¢ {{ product.location }}
                            {% endif %}
                        </div>
                        <div class="product-seller">
                            <img src="https://via.placeholder.com/24x24/FF6A00/ffffff?text=U" alt="{{ product.seller.username }}">
                            <span>{{ product.seller.username }}</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="no-products-message">
                    <div style="text-align: center; padding: 60px 20px;">
                        <div style="font-size: 80px; color: #ddd; margin-bottom: 20px;">
                            <i class="fas fa-search"></i>
                        </div>
                        <h3 style="color: #666; margin-bottom: 15px;">No products found</h3>
                        {% if search_query %}
                            <p style="color: #888; margin-bottom: 20px;">No products match your search criteria.</p>
                            <a href="{% url 'products' %}" class="btn btn-primary">View All Products</a>
                        {% else %}
                            <p style="color: #888; margin-bottom: 20px;">No products are available yet. Be the first to list something!</p>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
/* Horizontal Categories Navigation Styles */
.horizontal-categories {
    background-color: #fff;
    border-bottom: 1px solid #eee;
    position: relative;
    overflow: hidden;
    padding: 0 15px;
}

.horizontal-categories-container {
    display: flex;
    overflow-x: auto;
    scrollbar-width: none;
    -ms-overflow-style: none;
    padding: 10px 0;
    scroll-behavior: smooth;
}

.horizontal-categories-container::-webkit-scrollbar {
    display: none;
}

.category-link {
    white-space: nowrap;
    padding: 8px 15px;
    color: #333;
    text-decoration: none;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.3s ease;
}

.category-link:hover, .category-link.active {
    color: #FF6A00;
}

.scroll-arrow {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background: #fff;
    border: 1px solid #eee;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 10;
    color: #FF6A00;
    transition: all 0.3s ease;
}

.scroll-arrow:hover {
    background: #FF6A00;
    color: white;
}

.scroll-arrow.right {
    right: 10px;
}

/* Categories Sidebar */
.categories-sidebar {
    width: 200px;
    padding: 15px;
    background-color: white;
    border-radius: 4px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    margin-right: 20px;
    height: fit-content;
}

.categories-sidebar h3 {
    margin-bottom: 15px;
    font-size: 18px;
    color: #333;
}

.categories-sidebar ul li {
    padding: 8px 10px;
    margin-bottom: 7px;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
    transition: all 0.3s ease;
}

.categories-sidebar ul li:hover {
    background-color: #f0f0f0;
}

.categories-sidebar ul li.active {
    background-color: #FF6A00;
    color: white;
}

.categories-sidebar ul li i {
    margin-right: 8px;
}

.categories-sidebar .badge {
    background-color: #FF6A00;
    color: white;
    padding: 2px 6px;
    border-radius: 10px;
    font-size: 12px;
}

/* Posts Feed */
.posts-feed {
    flex: 1;
    background-color: white;
    border-radius: 4px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    padding: 20px;
}

.posts-feed h2 {
    margin-bottom: 20px;
    color: #333;
}

/* Advanced Filters */
.advanced-filters {
    background-color: #f8f9fa;
    border-radius: 8px;
    margin-bottom: 20px;
    overflow: hidden;
}

.filters-header {
    padding: 15px 20px;
    background-color: #fff;
    border-bottom: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
}

.filters-header h3 {
    margin: 0;
    font-size: 16px;
    color: #333;
}

.filters-toggle {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #666;
    font-size: 14px;
}

.filters-body {
    padding: 20px;
    display: none;
}

.filter-section {
    margin-bottom: 20px;
}

.filter-section h4 {
    margin-bottom: 10px;
    font-size: 14px;
    color: #333;
    font-weight: 600;
}

.price-inputs {
    display: flex;
    align-items: center;
    gap: 10px;
}

.price-inputs .field {
    position: relative;
    flex: 1;
}

.price-inputs .field span {
    position: absolute;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    color: #666;
}

.price-inputs .field input {
    width: 100%;
    padding: 8px 8px 8px 25px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

.separator {
    color: #666;
    font-size: 14px;
}

.checkbox-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.checkbox-item {
    display: flex;
    align-items: center;
    gap: 8px;
}

.checkbox-item input[type="checkbox"] {
    margin: 0;
}

.checkbox-item label {
    font-size: 14px;
    color: #333;
    cursor: pointer;
}

.filter-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}

.reset-btn, .apply-btn {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s ease;
}

.reset-btn {
    background-color: #f8f9fa;
    color: #666;
    border: 1px solid #ddd;
}

.apply-btn {
    background-color: #FF6A00;
    color: white;
}

/* Filter and Sort Bar */
.filter-sort-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 0;
    border-bottom: 1px solid #eee;
    margin-bottom: 20px;
}

.filter-section, .sort-section {
    display: flex;
    align-items: center;
    gap: 10px;
}

.filter-label {
    font-size: 14px;
    color: #666;
    font-weight: 500;
}

.price-filter .price-inputs input {
    width: 80px;
    padding: 6px 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

.price-separator {
    color: #666;
}

.filter-btn {
    padding: 6px 12px;
    background-color: #FF6A00;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.filter-btn:hover {
    background-color: #e55f00;
}

.sort-select {
    padding: 6px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
    background-color: white;
}

/* Products Container */
.posts-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 20px;
}

.product-card {
    border: 1px solid #eee;
    border-radius: 8px;
    overflow: hidden;
    transition: all 0.3s ease;
    background-color: white;
}

.product-card:hover {
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
}

.product-image {
    position: relative;
    height: 180px;
    overflow: hidden;
}

.product-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
}

.product-card:hover .product-image img {
    transform: scale(1.05);
}

.product-badge {
    position: absolute;
    top: 10px;
    left: 10px;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
    z-index: 2;
}

.badge-new {
    background-color: #34a853;
    color: white;
}

.badge-sold {
    background-color: #ea4335;
    color: white;
}

.badge-reserved {
    background-color: #fbbc05;
    color: #333;
}

.product-wishlist {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 32px;
    height: 32px;
    background-color: rgba(255, 255, 255, 0.9);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    z-index: 2;
}

.product-wishlist:hover {
    background-color: #FF6A00;
    color: white;
}

.product-actions {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(transparent, rgba(0, 0, 0, 0.7));
    padding: 20px 15px 15px;
    transform: translateY(100%);
    transition: transform 0.3s ease;
}

.product-card:hover .product-actions {
    transform: translateY(0);
}

.action-button {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    background-color: #FF6A00;
    color: white;
    text-decoration: none;
    border-radius: 4px;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.3s ease;
}

.action-button:hover {
    background-color: #e55f00;
    text-decoration: none;
    color: white;
}

.product-info {
    padding: 15px;
}

.product-category {
    font-size: 12px;
    color: #666;
    text-transform: uppercase;
    font-weight: 600;
    margin-bottom: 5px;
}

.product-title {
    font-size: 16px;
    font-weight: 600;
    color: #333;
    margin-bottom: 8px;
    line-height: 1.3;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.product-price {
    margin-bottom: 8px;
}

.current-price {
    font-size: 18px;
    font-weight: 700;
    color: #34a853;
}

.product-moq {
    font-size: 12px;
    color: #666;
    margin-bottom: 10px;
}

.product-seller {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    color: #666;
}

.product-seller img {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    object-fit: cover;
}

/* Responsive Design */
@media (max-width: 768px) {
    .main-content {
        flex-direction: column;
    }

    .categories-sidebar {
        width: 100%;
        margin-right: 0;
        margin-bottom: 20px;
    }

    .filter-sort-bar {
        flex-direction: column;
        gap: 15px;
        align-items: stretch;
    }

    .posts-container {
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Toggle advanced filters
    const filtersHeader = document.querySelector('.filters-header');
    const filtersBody = document.querySelector('.filters-body');
    const filtersToggle = document.querySelector('.filters-toggle i');

    if (filtersHeader && filtersBody) {
        filtersHeader.addEventListener('click', function() {
            const isVisible = filtersBody.style.display === 'block';
            filtersBody.style.display = isVisible ? 'none' : 'block';
            filtersToggle.className = isVisible ? 'fas fa-chevron-down' : 'fas fa-chevron-up';
        });
    }

    // Horizontal categories scrolling
    const scrollRightBtn = document.getElementById('scrollRight');
    const categoriesContainer = document.querySelector('.horizontal-categories-container');

    if (scrollRightBtn && categoriesContainer) {
        scrollRightBtn.addEventListener('click', function() {
            categoriesContainer.scrollBy({
                left: 200,
                behavior: 'smooth'
            });
        });
    }

    // Category sidebar clicks
    const categoryItems = document.querySelectorAll('.categories-sidebar ul li');
    categoryItems.forEach(function(item) {
        item.addEventListener('click', function() {
            const category = this.getAttribute('data-category');
            if (category === 'all') {
                window.location.href = '{% url "products" %}';
            } else {
                // Find the category ID and redirect
                const categoryLinks = document.querySelectorAll('.horizontal-categories .category-link');
                categoryLinks.forEach(function(link) {
                    if (link.getAttribute('data-category') === category) {
                        window.location.href = link.href;
                    }
                });
            }
        });
    });
});
</script>
{% endblock %}